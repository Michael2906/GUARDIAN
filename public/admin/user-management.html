<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management - GUARDIAN 3PL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="text-2xl font-bold text-purple-600">
              <i class="fas fa-shield-alt mr-2"></i>GUARDIAN
            </div>
            <span class="text-gray-400">|</span>
            <h1 class="text-xl font-semibold text-gray-800">User Management</h1>
          </div>
          <div class="flex items-center space-x-4">
            <!-- User Options Dropdown -->
            <div class="relative">
              <button
                id="user-menu-button"
                onclick="toggleUserMenu()"
                class="flex items-center space-x-2 text-sm text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500 rounded-lg px-3 py-2 transition-colors"
              >
                <div class="flex items-center space-x-2">
                  <div
                    class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-xs font-medium"
                    id="user-avatar"
                  >
                    <i class="fas fa-user"></i>
                  </div>
                  <span id="user-name" class="font-medium">Loading...</span>
                  <i
                    class="fas fa-chevron-down transition-transform"
                    id="user-menu-chevron"
                  ></i>
                </div>
              </button>

              <!-- Dropdown Menu -->
              <div
                id="user-menu"
                class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
              >
                <!-- User Info Header -->
                <div class="px-4 py-3 border-b border-gray-100">
                  <div class="flex items-center space-x-3">
                    <div
                      class="bg-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm font-medium"
                      id="user-avatar-large"
                    >
                      <i class="fas fa-user"></i>
                    </div>
                    <div>
                      <p
                        class="text-sm font-medium text-gray-900"
                        id="user-full-name"
                      >
                        Loading...
                      </p>
                      <p class="text-xs text-gray-600" id="user-email">
                        Loading...
                      </p>
                      <span
                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 mt-1"
                        id="user-role-badge"
                      >
                        <i class="fas fa-crown mr-1"></i>GUARDIAN Admin
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Menu Items -->
                <div class="py-2">
                  <!-- Account Settings -->
                  <button
                    onclick="viewProfile()"
                    class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                  >
                    <i class="fas fa-user-circle text-gray-400 mr-3 w-4"></i>
                    View Profile
                  </button>

                  <!-- Account Security -->
                  <button
                    onclick="accountSecurity()"
                    class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                  >
                    <i class="fas fa-shield-alt text-gray-400 mr-3 w-4"></i>
                    Account Security
                  </button>

                  <!-- 2FA Setup -->
                  <button
                    onclick="setup2FA()"
                    class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                  >
                    <i class="fas fa-mobile-alt text-gray-400 mr-3 w-4"></i>
                    Two-Factor Authentication
                  </button>

                  <!-- Change Password -->
                  <button
                    onclick="changePassword()"
                    class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                  >
                    <i class="fas fa-key text-gray-400 mr-3 w-4"></i>
                    Change Password
                  </button>

                  <!-- Preferences -->
                  <button
                    onclick="userPreferences()"
                    class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                  >
                    <i class="fas fa-cog text-gray-400 mr-3 w-4"></i>
                    Preferences
                  </button>
                </div>

                <div class="border-t border-gray-100 py-2">
                  <!-- Navigation Items -->
                  <button
                    onclick="navigateTo('/admin/admin-dashboard.html')"
                    class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                  >
                    <i
                      class="fas fa-tachometer-alt text-purple-500 mr-3 w-4"
                    ></i>
                    Admin Dashboard
                  </button>

                  <button
                    onclick="navigateTo('/dashboard.html')"
                    class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                  >
                    <i class="fas fa-home text-gray-500 mr-3 w-4"></i>
                    User Dashboard
                  </button>
                </div>

                <div class="border-t border-gray-100 py-2">
                  <!-- Logout -->
                  <button
                    onclick="logout()"
                    class="w-full flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700"
                  >
                    <i class="fas fa-sign-out-alt text-red-500 mr-3 w-4"></i>
                    Sign Out
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
            <p class="text-gray-600 mt-2">
              Manage users across the GUARDIAN platform
            </p>
          </div>
          <button
            onclick="openCreateUserModal()"
            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
          >
            <i class="fas fa-plus mr-2"></i>Add New User
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Search Users</label
            >
            <input
              type="text"
              id="search-input"
              placeholder="Name or email..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
              onkeyup="debounceSearch()"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >User Type</label
            >
            <select
              id="user-type-filter"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
              onchange="loadUsers()"
            >
              <option value="">All Types</option>
              <option value="guardian-admin">GUARDIAN Admin</option>
              <option value="storage-admin">Storage Admin</option>
              <option value="storage-manager">Storage Manager</option>
              <option value="storage-employee">Storage Employee</option>
              <option value="client-admin">Client Admin</option>
              <option value="client-user">Client User</option>
              <option value="client-viewer">Client Viewer</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >2FA Status</label
            >
            <select
              id="2fa-status-filter"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
              onchange="loadUsers()"
            >
              <option value="">All Users</option>
              <option value="enabled">2FA Enabled</option>
              <option value="disabled">2FA Disabled</option>
            </select>
          </div>
          <div id="storage-company-filter-container" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Storage Company</label
            >
            <select
              id="storage-company-filter"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
              onchange="loadUsers()"
            >
              <option value="">All Companies</option>
            </select>
          </div>
          <div class="flex items-end">
            <button
              onclick="clearFilters()"
              class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors"
            >
              <i class="fas fa-times mr-2"></i>Clear Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  User
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Role
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Company
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  2FA
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Created
                </th>
                <th
                  class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="users-table-body"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-2xl text-purple-600 mb-2"></i>
          <p class="text-gray-600">Loading users...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-8 hidden">
          <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
          <p class="text-gray-600">No users found</p>
        </div>
      </div>

      <!-- Pagination -->
      <div
        id="pagination-container"
        class="mt-6 flex items-center justify-between"
      >
        <div class="text-sm text-gray-700" id="pagination-info">
          <!-- Pagination info will be loaded here -->
        </div>
        <div class="flex space-x-2" id="pagination-buttons">
          <!-- Pagination buttons will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div
      id="user-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold" id="modal-title">Add New User</h3>
            <button
              onclick="closeUserModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <form id="user-form">
            <input type="hidden" id="user-id" />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >First Name *</label
                >
                <input
                  type="text"
                  id="first-name"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Last Name *</label
                >
                <input
                  type="text"
                  id="last-name"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                />
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email Address *</label
              >
              <input
                type="email"
                id="email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
              />
            </div>

            <div id="password-field" class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Password *</label
              >
              <input
                type="password"
                id="password"
                required
                minlength="8"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
              />
              <p class="text-xs text-gray-500 mt-1">Minimum 8 characters</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >User Type *</label
                >
                <select
                  id="user-type"
                  required
                  onchange="handleUserTypeChange()"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                >
                  <option value="">Select User Type</option>
                  <option value="guardian-admin">GUARDIAN Admin</option>
                  <option value="storage-admin">Storage Admin</option>
                  <option value="storage-manager">Storage Manager</option>
                  <option value="storage-employee">Storage Employee</option>
                  <option value="client-admin">Client Admin</option>
                  <option value="client-user">Client User</option>
                  <option value="client-viewer">Client Viewer</option>
                </select>
              </div>
              <div id="storage-company-field">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Storage Company *</label
                >
                <select
                  id="storage-company"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                >
                  <option value="">Select Storage Company</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Job Title</label
                >
                <input
                  type="text"
                  id="job-title"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Department</label
                >
                <input
                  type="text"
                  id="department"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                />
              </div>
            </div>

            <div class="flex justify-end space-x-3">
              <button
                type="button"
                onclick="closeUserModal()"
                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="submit-button"
                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
              >
                <i class="fas fa-plus mr-2"></i>Create User
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div id="message-container" class="hidden fixed top-4 right-4 z-50">
      <div id="message" class="p-4 rounded-lg shadow-lg"></div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:3000/api";
      let currentUser = null;
      let searchTimeout = null;
      let currentPage = 1;
      let isEditMode = false;

      // Get auth token
      function getAuthToken() {
        return localStorage.getItem("guardian_access_token");
      }

      // Show message
      function showMessage(message, type = "error") {
        const container = document.getElementById("message-container");
        const messageEl = document.getElementById("message");

        messageEl.textContent = message;

        let className = "p-4 rounded-lg shadow-lg ";
        switch (type) {
          case "success":
            className += "bg-green-100 text-green-800 border border-green-200";
            break;
          case "info":
            className += "bg-blue-100 text-blue-800 border border-blue-200";
            break;
          case "warning":
            className +=
              "bg-yellow-100 text-yellow-800 border border-yellow-200";
            break;
          default:
            className += "bg-red-100 text-red-800 border border-red-200";
        }

        messageEl.className = className;
        container.classList.remove("hidden");

        setTimeout(() => container.classList.add("hidden"), 5000);
      }

      // Load current user info
      async function loadCurrentUser() {
        try {
          const token = getAuthToken();
          if (!token) {
            window.location.href = "/";
            return;
          }

          const response = await fetch(`${API_BASE_URL}/auth/verify`, {
            headers: { "Authorization": `Bearer ${token}` },
          });

          if (!response.ok) throw new Error("Authentication failed");

          const data = await response.json();
          currentUser = data.data.user;

          // Update user info in header dropdown
          const initials = (
            currentUser.firstName[0] + currentUser.lastName[0]
          ).toUpperCase();
          document.getElementById(
            "user-name"
          ).textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          document.getElementById(
            "user-full-name"
          ).textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          document.getElementById("user-email").textContent = currentUser.email;

          // Update avatars with initials
          document.getElementById("user-avatar").textContent = initials;
          document.getElementById("user-avatar-large").textContent = initials;

          // Update role badge
          const roleBadge = document.getElementById("user-role-badge");
          if (currentUser.role === "guardian-admin") {
            roleBadge.innerHTML =
              '<i class="fas fa-crown mr-1"></i>GUARDIAN Admin';
            roleBadge.className =
              "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 mt-1";
          } else if (currentUser.role.includes("storage")) {
            roleBadge.innerHTML =
              '<i class="fas fa-warehouse mr-1"></i>Storage Admin';
            roleBadge.className =
              "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mt-1";
          } else {
            roleBadge.innerHTML = '<i class="fas fa-shield-alt mr-1"></i>Admin';
            roleBadge.className =
              "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mt-1";
          }

          // Show storage company filter for GUARDIAN admins
          if (currentUser.role === "guardian-admin") {
            document
              .getElementById("storage-company-filter-container")
              .classList.remove("hidden");
            loadStorageCompanies();
          }
        } catch (error) {
          console.error("Failed to load user info:", error);
          localStorage.removeItem("guardian_access_token");
          window.location.href = "/";
        }
      }

      // Load storage companies for filters and form
      async function loadStorageCompanies() {
        try {
          const token = getAuthToken();
          const response = await fetch(
            `${API_BASE_URL}/companies?status=active&limit=100`,
            {
              headers: { "Authorization": `Bearer ${token}` },
            }
          );

          if (response.ok) {
            const data = await response.json();
            const companies = data.data.companies || [];

            // Populate filter dropdown
            const filterSelect = document.getElementById(
              "storage-company-filter"
            );
            filterSelect.innerHTML = '<option value="">All Companies</option>';

            // Populate form dropdown
            const formSelect = document.getElementById("storage-company");
            if (formSelect) {
              formSelect.innerHTML =
                '<option value="">Select Storage Company</option>';
            }

            companies.forEach((company) => {
              const filterOption = new Option(company.name, company._id);
              filterSelect.add(filterOption);

              if (formSelect) {
                const formOption = new Option(company.name, company._id);
                formSelect.add(formOption);
              }
            });
          }
        } catch (error) {
          console.error("Failed to load storage companies:", error);
        }
      }

      // Load users with filtering support
      async function loadUsers(page = 1) {
        try {
          // Show loading state
          const tbody = document.getElementById("users-table-body");
          const loadingState = document.getElementById("loading-state");
          const emptyState = document.getElementById("empty-state");

          loadingState.classList.remove("hidden");
          emptyState.classList.add("hidden");
          tbody.innerHTML = "";

          currentPage = page;
          const token = getAuthToken();

          if (!token) {
            throw new Error(
              "Authentication token not found. Please log in again."
            );
          }

          // Build query parameters
          const params = new URLSearchParams();
          params.append("page", page);
          params.append("limit", "20");

          const search = document.getElementById("search-input")?.value;
          if (search) params.append("search", search);

          const userType = document.getElementById("user-type-filter")?.value;
          if (userType) params.append("userType", userType);

          const storageCompanyId = document.getElementById(
            "storage-company-filter"
          )?.value;
          if (storageCompanyId)
            params.append("storageCompanyId", storageCompanyId);

          const twoFactorStatus =
            document.getElementById("2fa-status-filter")?.value;
          if (twoFactorStatus)
            params.append("twoFactorStatus", twoFactorStatus);

          console.log("Loading users with params:", params.toString());

          const response = await fetch(`${API_BASE_URL}/users?${params}`, {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          console.log("Response status:", response.status);

          if (!response.ok) {
            const errorData = await response
              .json()
              .catch(() => ({ error: "Network error" }));
            throw new Error(
              errorData.error || `HTTP ${response.status}: Failed to load users`
            );
          }

          const data = await response.json();
          console.log("Response data:", data);

          if (data.success && data.data) {
            displayUsers(data.data.users || []);
            displayPagination(
              data.data.pagination || { page: 1, pages: 1, total: 0 }
            );
          } else {
            throw new Error(data.error || "Invalid response format");
          }
        } catch (error) {
          console.error("Failed to load users:", error);
          showMessage(error.message || "Failed to load users");

          // Show empty state on error
          const tbody = document.getElementById("users-table-body");
          const loadingState = document.getElementById("loading-state");
          const emptyState = document.getElementById("empty-state");

          loadingState.classList.add("hidden");
          tbody.innerHTML = "";
          emptyState.classList.remove("hidden");
        }
      }

      // Display users in table
      function displayUsers(users) {
        const tbody = document.getElementById("users-table-body");
        const loadingState = document.getElementById("loading-state");
        const emptyState = document.getElementById("empty-state");

        loadingState.classList.add("hidden");

        // Filter out the current user from the list
        const filteredUsers = users.filter((user) => {
          return currentUser && user._id !== currentUser.id;
        });

        if (filteredUsers.length === 0) {
          tbody.innerHTML = "";
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");

        tbody.innerHTML = filteredUsers
          .map(
            (user) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                                    <span class="text-sm font-medium text-purple-600">
                                        ${user.firstName[0]}${user.lastName[0]}
                                    </span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">
                                    ${user.firstName} ${user.lastName}
                                </div>
                                <div class="text-sm text-gray-500">${
                                  user.email
                                }</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getRoleBadgeClass(
                          user.userType
                        )}">
                            ${formatUserType(user.userType)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${
                          user.storageCompanyId
                            ? user.storageCompanyId.name
                            : "GUARDIAN Platform"
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                          user.isActive
                            ? "bg-green-100 text-green-800"
                            : "bg-red-100 text-red-800"
                        }">
                            ${user.isActive ? "Active" : "Inactive"}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center space-x-1">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                              user.twoFactorAuth?.enabled
                                ? "bg-green-100 text-green-800"
                                : "bg-gray-100 text-gray-800"
                            }">
                                ${
                                  user.twoFactorAuth?.enabled
                                    ? "Enabled"
                                    : "Disabled"
                                }
                            </span>
                            <button 
                                onclick="toggle2FA('${user._id}', ${
              user.twoFactorAuth?.enabled || false
            })"
                                class="text-xs px-2 py-1 rounded ${
                                  user.twoFactorAuth?.enabled
                                    ? "bg-red-100 text-red-600 hover:bg-red-200"
                                    : "bg-purple-100 text-purple-600 hover:bg-purple-200"
                                }"
                                title="${
                                  user.twoFactorAuth?.enabled
                                    ? "Disable 2FA"
                                    : "Enable 2FA"
                                }"
                            >
                                ${
                                  user.twoFactorAuth?.enabled
                                    ? "Disable"
                                    : "Enable"
                                }
                            </button>
                            ${
                              user.twoFactorAuth?.enabled ||
                              user.twoFactorAuth?.secret
                                ? `
                            <button 
                                onclick="reset2FA('${user._id}', '${user.firstName} ${user.lastName}')"
                                class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700 hover:bg-yellow-200"
                                title="Reset 2FA Configuration"
                            >
                                Reset
                            </button>
                            `
                                : ""
                            }
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(user.createdAt).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end space-x-2">
                            <button 
                                onclick="editUser('${user._id}')"
                                class="text-blue-600 hover:text-blue-900"
                                title="Edit User"
                            >
                                <i class="fas fa-edit"></i>
                            </button>
                            ${
                              user._id !== currentUser.id
                                ? `
                                <button 
                                    onclick="deleteUser('${user._id}', '${user.firstName} ${user.lastName}')"
                                    class="text-red-600 hover:text-red-900"
                                    title="Delete User"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            `
                                : ""
                            }
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Get role badge class
      function getRoleBadgeClass(userType) {
        const classes = {
          "guardian-admin": "bg-purple-100 text-purple-800",
          "storage-admin": "bg-blue-100 text-blue-800",
          "storage-manager": "bg-indigo-100 text-indigo-800",
          "storage-employee": "bg-gray-100 text-gray-800",
          "client-admin": "bg-green-100 text-green-800",
          "client-user": "bg-emerald-100 text-emerald-800",
          "client-viewer": "bg-teal-100 text-teal-800",
        };
        return classes[userType] || "bg-gray-100 text-gray-800";
      }

      // Format user type for display
      function formatUserType(userType) {
        const formats = {
          "guardian-admin": "GUARDIAN Admin",
          "storage-admin": "Storage Admin",
          "storage-manager": "Storage Manager",
          "storage-employee": "Storage Employee",
          "client-admin": "Client Admin",
          "client-user": "Client User",
          "client-viewer": "Client Viewer",
        };
        return formats[userType] || userType;
      }

      // Display pagination
      function displayPagination(pagination) {
        const paginationInfo = document.getElementById("pagination-info");
        const paginationButtons = document.getElementById("pagination-buttons");

        paginationInfo.textContent = `Showing ${
          (pagination.page - 1) * pagination.limit + 1
        } to ${Math.min(
          pagination.page * pagination.limit,
          pagination.total
        )} of ${pagination.total} results`;

        let buttonsHTML = "";

        // Previous button
        if (pagination.page > 1) {
          buttonsHTML += `
                    <button onclick="loadUsers(${
                      pagination.page - 1
                    })" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-chevron-left mr-1"></i>Previous
                    </button>
                `;
        }

        // Page numbers
        for (
          let i = Math.max(1, pagination.page - 2);
          i <= Math.min(pagination.pages, pagination.page + 2);
          i++
        ) {
          buttonsHTML += `
                    <button 
                        onclick="loadUsers(${i})" 
                        class="px-3 py-2 text-sm ${
                          i === pagination.page
                            ? "bg-purple-600 text-white"
                            : "bg-white text-gray-700 hover:bg-gray-50"
                        } border border-gray-300 rounded-lg"
                    >
                        ${i}
                    </button>
                `;
        }

        // Next button
        if (pagination.page < pagination.pages) {
          buttonsHTML += `
                    <button onclick="loadUsers(${
                      pagination.page + 1
                    })" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        Next<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                `;
        }

        paginationButtons.innerHTML = buttonsHTML;
      }

      // Debounced search
      function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          loadUsers(1);
        }, 300);
      }

      // Clear filters
      function clearFilters() {
        document.getElementById("search-input").value = "";
        document.getElementById("user-type-filter").value = "";
        document.getElementById("storage-company-filter").value = "";
        loadUsers(1);
      }

      // Open create user modal
      function openCreateUserModal() {
        isEditMode = false;
        document.getElementById("modal-title").textContent = "Add New User";
        document.getElementById("submit-button").innerHTML =
          '<i class="fas fa-plus mr-2"></i>Create User';
        document.getElementById("user-form").reset();
        document.getElementById("user-id").value = "";
        document.getElementById("password-field").classList.remove("hidden");
        document.getElementById("password").required = true;
        handleUserTypeChange();
        document.getElementById("user-modal").classList.remove("hidden");
      }

      // Close user modal
      function closeUserModal() {
        document.getElementById("user-modal").classList.add("hidden");
        document.getElementById("user-form").reset();
      }

      // Handle user type change
      function handleUserTypeChange() {
        const userType = document.getElementById("user-type").value;
        const storageCompanyField = document.getElementById(
          "storage-company-field"
        );
        const storageCompanySelect = document.getElementById("storage-company");

        if (userType === "guardian-admin") {
          storageCompanyField.style.display = "none";
          storageCompanySelect.required = false;
          storageCompanySelect.value = "";
        } else {
          storageCompanyField.style.display = "block";
          storageCompanySelect.required = true;
        }
      }

      // Create/Update user
      document
        .getElementById("user-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            firstName: document.getElementById("first-name").value,
            lastName: document.getElementById("last-name").value,
            email: document.getElementById("email").value,
            userType: document.getElementById("user-type").value,
            jobTitle: document.getElementById("job-title").value,
            department: document.getElementById("department").value,
          };

          if (!isEditMode) {
            formData.password = document.getElementById("password").value;
          }

          if (formData.userType !== "guardian-admin") {
            formData.storageCompanyId =
              document.getElementById("storage-company").value;
          }

          try {
            const token = getAuthToken();
            const userId = document.getElementById("user-id").value;

            const url = isEditMode
              ? `${API_BASE_URL}/users/${userId}`
              : `${API_BASE_URL}/users`;
            const method = isEditMode ? "PUT" : "POST";

            const response = await fetch(url, {
              method,
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (data.success) {
              showMessage(data.message, "success");
              closeUserModal();
              loadUsers(currentPage);
            } else {
              showMessage(data.error);
            }
          } catch (error) {
            console.error("User save error:", error);
            showMessage("Failed to save user");
          }
        });

      // Edit user
      async function editUser(userId) {
        try {
          const token = getAuthToken();
          const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
            headers: { "Authorization": `Bearer ${token}` },
          });

          const data = await response.json();
          if (data.success) {
            const user = data.data.user;

            isEditMode = true;
            document.getElementById("modal-title").textContent = "Edit User";
            document.getElementById("submit-button").innerHTML =
              '<i class="fas fa-save mr-2"></i>Update User';
            document.getElementById("password-field").classList.add("hidden");
            document.getElementById("password").required = false;

            document.getElementById("user-id").value = user._id;
            document.getElementById("first-name").value = user.firstName;
            document.getElementById("last-name").value = user.lastName;
            document.getElementById("email").value = user.email;
            document.getElementById("user-type").value = user.userType;
            document.getElementById("job-title").value = user.jobTitle || "";
            document.getElementById("department").value = user.department || "";

            if (user.storageCompanyId) {
              document.getElementById("storage-company").value =
                user.storageCompanyId._id;
            }

            handleUserTypeChange();
            document.getElementById("user-modal").classList.remove("hidden");
          } else {
            showMessage(data.error);
          }
        } catch (error) {
          console.error("Failed to load user:", error);
          showMessage("Failed to load user details");
        }
      }

      // Delete user
      async function deleteUser(userId, userName) {
        if (
          !confirm(
            `Are you sure you want to delete ${userName}? This action cannot be undone.`
          )
        ) {
          return;
        }

        try {
          const token = getAuthToken();
          const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` },
          });

          const data = await response.json();
          if (data.success) {
            showMessage(data.message, "success");
            loadUsers(currentPage);
          } else {
            showMessage(data.error);
          }
        } catch (error) {
          console.error("Failed to delete user:", error);
          showMessage("Failed to delete user");
        }
      }

      // User Menu Functions
      function toggleUserMenu() {
        const menu = document.getElementById("user-menu");
        const chevron = document.getElementById("user-menu-chevron");

        if (menu.classList.contains("hidden")) {
          menu.classList.remove("hidden");
          chevron.style.transform = "rotate(180deg)";
        } else {
          menu.classList.add("hidden");
          chevron.style.transform = "rotate(0deg)";
        }
      }

      // Close user menu when clicking outside
      document.addEventListener("click", function (event) {
        const userMenuButton = document.getElementById("user-menu-button");
        const userMenu = document.getElementById("user-menu");

        if (
          !userMenuButton.contains(event.target) &&
          !userMenu.contains(event.target)
        ) {
          userMenu.classList.add("hidden");
          document.getElementById("user-menu-chevron").style.transform =
            "rotate(0deg)";
        }
      });

      // User Option Functions
      function viewProfile() {
        toggleUserMenu();
        showMessage("Profile management feature coming soon!", "info");
      }

      function accountSecurity() {
        toggleUserMenu();
        showMessage("Account security dashboard coming soon!", "info");
      }

      function setup2FA() {
        toggleUserMenu();
        navigateTo("/2fa-setup.html");
      }

      function changePassword() {
        toggleUserMenu();

        // Show a simple password change modal (placeholder)
        const newPassword = prompt(
          "Enter your new password (minimum 8 characters):"
        );
        if (newPassword && newPassword.length >= 8) {
          showMessage("Password change feature coming soon!", "info");
        } else if (newPassword !== null) {
          showMessage("Password must be at least 8 characters long.", "error");
        }
      }

      function userPreferences() {
        toggleUserMenu();
        showMessage("User preferences panel coming soon!", "info");
      }

      function navigateTo(path) {
        window.location.href = path;
      }

      // Logout
      function logout() {
        toggleUserMenu();

        if (confirm("Are you sure you want to sign out?")) {
          localStorage.removeItem("guardian_access_token");
          localStorage.removeItem("guardian_refresh_token");
          localStorage.removeItem("guardian_user");
          window.location.href = "/";
        }
      }

      // Toggle 2FA for user
      async function toggle2FA(userId, currentStatus) {
        const action = currentStatus ? "disable" : "enable";
        const userName =
          document
            .querySelector(`button[onclick*="${userId}"][title="Edit User"]`)
            ?.closest("tr")
            ?.querySelector(".text-gray-900")?.textContent || "this user";

        // Show reason prompt for disabling 2FA
        let reason = null;
        if (currentStatus) {
          reason = prompt(
            `Please provide a reason for disabling 2FA for ${userName}:`
          );
          if (reason === null) return; // User cancelled
        }

        if (
          !confirm(`Are you sure you want to ${action} 2FA for ${userName}?`)
        ) {
          return;
        }

        try {
          const token = getAuthToken();
          const response = await fetch(
            `${API_BASE_URL}/admin/users/${userId}/2fa/${action}`,
            {
              method: "PUT", // Changed to PUT to match backend
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                reason: reason || undefined,
              }),
            }
          );

          const data = await response.json();
          if (data.success) {
            showMessage(
              data.message || `2FA ${action}d successfully`,
              "success"
            );
            loadUsers(currentPage); // Reload current page
          } else {
            showMessage(data.error || `Failed to ${action} 2FA`);
          }
        } catch (error) {
          console.error("2FA toggle error:", error);
          showMessage(`Network error: Failed to ${action} 2FA`);
        }
      }

      // Reset 2FA configuration for a user
      async function reset2FA(userId, userName) {
        const reason = prompt(
          `Please provide a reason for resetting 2FA configuration for ${userName}:`
        );
        if (reason === null) return; // User cancelled

        if (
          !confirm(
            `Are you sure you want to reset 2FA configuration for ${userName}? This will remove their authenticator app setup and backup codes.`
          )
        ) {
          return;
        }

        try {
          const token = getAuthToken();
          const response = await fetch(
            `${API_BASE_URL}/admin/users/${userId}/2fa/reset`,
            {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ reason }),
            }
          );

          const data = await response.json();
          if (data.success) {
            showMessage(
              data.message || "2FA configuration reset successfully",
              "success"
            );
            loadUsers(currentPage); // Reload current page
          } else {
            showMessage(data.error || "Failed to reset 2FA configuration");
          }
        } catch (error) {
          console.error("2FA reset error:", error);
          showMessage("Network error: Failed to reset 2FA configuration");
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadCurrentUser();
        loadUsers();
      });
    </script>
  </body>
</html>
